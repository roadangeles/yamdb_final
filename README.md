# API YAMDB
API для получения информации и обсуждения произведений литературы, музыки и кино.

### Стек технологий:
- Python 
- Django REST framework
- Django Rest Framework
- Django Rest Framework Simplejwt
- Gunicorn
- Docker
- nginx
- PostgreSQL
- GIT

### Проект YaMDb собирает отзывы (Review) пользователей на произведения (Titles). 

В каждой категории есть произведения: книги, фильмы или музыка. Например, в категории «Книги» могут быть произведения «Винни-Пух и все-все-все» и «Марсианские хроники», а в категории «Музыка» — песня «Давеча» группы «Насекомые» и вторая сюита Баха.
Произведению может быть присвоен жанр (Genre) из списка предустановленных (например, «Сказка», «Рок» или «Артхаус»). Новые жанры может создавать только администратор.
Благодарные или возмущённые пользователи оставляют к произведениям текстовые отзывы (Review) и ставят произведению оценку в диапазоне от одного до десяти (целое число); из пользовательских оценок формируется усреднённая оценка произведения — рейтинг (целое число). На одно произведение пользователь может оставить только один отзыв.

## Техническое описание проекта YaMDb
Подробная документация доступна по [адресу](http://127.0.0.1:8000/redoc/) после запуска проекта. В ней описаны возможные запросы к API и структура ожидаемых ответов. Для каждого запроса указаны уровни прав доступа: пользовательские роли, которым разрешён запрос.

## Шаблон наполнения .env
- указать, с какой БД работаем:
DB_ENGINE=django.db.backends.postgresql
- ввести имя базы данных:
DB_NAME=
- ввести логин для подключения к базе данных:
POSTGRES_USER=
- ввести пароль для подключения к БД (установить свой)
POSTGRES_PASSWORD=
- указать название сервиса (контейнера):
DB_HOST=
- указать порт для подключения к БД:
DB_PORT=

## Пошаговая инструкция по автоматизации развертывания веб-приложений в проекте:
### Шаблон Dockerfile - файла с инструкцией по разворачиванию Docker-контейнера веб-приложения:

1. Создать образ на основе базового слоя python (там будет ОС и интерпретатор Python). 3.7 — используемая версия Python.
slim — обозначение того, что образ имеет только необходимые компоненты для запуска, он не будет занимать много места при развёртывании.
```
FROM python:3.7-slim
```
2. Запустить команду создания директории внутри контейнера
```
RUN mkdir /app
```
3. Скопировать с локального компьютера файл зависимостей в директорию /app.
```
COPY requirements.txt /app
```
4. Выполнить установку зависимостей внутри контейнера.
```
RUN pip3 install -r /app/requirements.txt --no-cache-dir
```
5. Скопировать содержимое директории /api_yamdb c локального компьютера в директорию /app.
```
COPY api_yamdb/ /app
```
6. Сделать директорию /app рабочей директорией. 
```
WORKDIR /app
```
7. Выполнить запуск сервера разработки при старте контейнера.
```
CMD ["gunicorn", "api_yamdb.wsgi:application", "--bind", "0:8000"]
```

#### Шаблон «docker-compose.yml» с описанием запускаемых контейнеров: веб-приложения, СУБД PostgreSQL и сервера Nginx.

```
# версия docker-compose
version: '3.8'

# имена и описания контейнеров, которые должны быть развёрнуты
services:
  # описание контейнера db
  db:
    # образ, из которого должен быть запущен контейнер
    image: postgres:13.0-alpine
    # volume и связанная с ним директория в контейнере
    volumes:
      - /var/lib/postgresql/data/
    # адрес файла, где хранятся переменные окружения
    env_file:
      - ./.env
  web:
    build: ../api_yamdb/
    restart: always
    volumes:
      # Контейнер web будет работать с данными, хранящиеся в томе static_value, 
      # через свою директорию /app/static/
      - static_value:/app/static/
      # Данные, хранящиеся в томе media_value, будут доступны в контейнере web 
      # через директорию /app/media/
      - media_value:/app/media/
    # «зависит от», 
    depends_on:
      - db
    env_file:
      - ./.env

  # Новый контейнер
  nginx:
    # образ, из которого должен быть запущен контейнер
    image: nginx:1.21.3-alpine

    # запросы с внешнего порта 80 перенаправляем на внутренний порт 80
    ports:
      - "80:80"

    volumes:
      # При сборке скопировать созданный конфиг nginx из исходной директории 
      # в контейнер и сохранить его в директорию /etc/nginx/conf.d/
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf

      # Контейнер nginx будет работать с данными, хранящиеся в томе static_value, 
      # через свою директорию /var/html/static/
      - static_value:/var/html/static/

      # Данные, хранящиеся в томе media_value, будут доступны в контейнере nginx
      # через директорию /var/html/media/
      - media_value:/var/html/media/

    depends_on:
      # Контейнер nginx должен быть запущен после контейнера web
      - web

volumes:
  # Новые тома 
  static_value:
  media_value:
  ```
## Команды для запуска приложения в контейнерах:
Для запуска проекта из директории infra_sp2 (с docker-compose.yaml) выполнить команду: docker-compose up -d --build.

После сборки контейнеров:
```
# Выполняем миграции
docker-compose exec web python manage.py migrate
# Создаем суперппользователя
docker-compose exec web python manage.py createsuperuser
# Собираем статику со всего проекта
docker-compose exec web python manage.py collectstatic --no-input
# Для дампа данных из БД
docker-compose exec web python manage.py dumpdata > dump.json
```
### 2. Примеры запросов:

#### 2.1 Пример POST-запроса - добавление нового поста:
_POST .../api/v1/posts/_
#### Пример ответа:
{
  "id": 0,
  
  "author": "string",
  
  "text": "string",
  
  "pub_date": "2019-08-24T14:15:22Z",
  
  "image": "string",
  
  "group": 0
}
#### 2.2 Пример POST-запроса - добавление комментария:
_POST .../api/v1/posts/{post_id}/comments/_
#### Пример ответа:
{
  "id": 0,
  "author": "string",
  "text": "string",
  "created": "2019-08-24T14:15:22Z",
  "post": 0
}
#### 2.3 Пример GET-запроса - получение списка групп:
_GET .../api/v1/groups/_
#### Пример ответа:
  {
    "id": 0,
    "title": "string",
    "slug": "string",
    "description": "string"
  }
#### 2.4 Пример POST-запроса - подписка:
Подписка пользователя от имени которого сделан запрос на пользователя переданного в теле запроса.
_POST .../api/v1/follow/_
#### Пример ответа:
{
  "user": "string",
  "following": "string"
}
#### 2.5 Пример GET-запроса - возвращает все подписки пользователя, сделавшего запрос:
_GET .../api/v1/follow/_
#### Пример ответа:
[
  {
    "user": "string",
    "following": "string"
  }
]

### Автор проекта:
[Ангелина Конева](https://github.com/roadangeles)
